#!/bin/sh

die()
{
	local exitcode
	exitcode=$1; shift
	echo >&2 "error: $@"
	exit ${exitcode}
}

die 1 "This script needs to be updated to handle permissions, not pre-create the log files (but yes pre-create the log directory)"

if [ -z "$1" -o -z "$2" -o -z "$3" -o -z "$4" ]; then
	die 1 "Usage: $0 user subdomain domain ext"
fi

user=$1
subdomain=$2
domain=$3
ext=$4

cd /home/${user}/sites || die 2 "/home/${user}/sites does not exist"
mkdir -p ${domain}.${ext}/${subdomain} || die 3 "unable to create ${domain}.${ext}/$subdomain"
cd ${domain}.${ext}/${subdomain}
mkdir content || die 4 "unable to create content dir"
mkdir logs || die 5 "unable to create logs dir"
touch logs/access
touch logs/errors

if [ -e http.conf ]; then
	die 6 "http.conf already exists"
fi
cat /etc/httpd/virtualhosttemplate.conf | sed s/ext/${ext}/ | sed s/domain/${domain}/ | sed s/subd/${subdomain}/ | sed s/someuser/${user}/ > http.conf || die 7 "unable to create http.conf"

echo Include /home/${user}/sites/${domain}.${ext}/${subdomain}/http.conf >> ../http.conf || die 8 "Unable to add subdomain http.conf to domain http.conf"
