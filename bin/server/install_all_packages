#!/bin/sh

# load the configuration
. /root/bin/update_all_packages.conf || exit $?

# load some utility functions
. /root/bin/util.sh || exit $?

(
	echo Determining packages to restart...
	cd ${RCDDIR}
	ALLRESTART=`tempname`
	for pkgname in `pkg_info -L -a | grep /rc\.d | awk '{ n=split(\$0, a, "/"); print a[n] }'`; do
		if [ -f ${pkgname} ]; then
			if ./${pkgname} status 2>/dev/null | grep -qE ^${pkgname}\ .*\d+ ; then
				echo ${pkgname} >> ${ALLRESTART} || die $?
			fi
		fi
	done

	extra_packages_for_restart >> ${ALLRESTART}

	echo Determining correct order in which to restart them...
	TORESTART=`tempname`
	for pkgname in `rcorder *`; do
		grep -Fxm 1 ${pkgname} ${ALLRESTART} >> ${TORESTART}
	done
	rm ${ALLRESTART} || die $?

	echo Stopping all installed packages...
	for pkgname in `cat ${TORESTART} | sort -r`; do
		echo -n "stopping ${pkgname}"
		if ./${pkgname} stop > /dev/null 2>&1; then
			echo
		else
			echo " ...failed (continuing anyway)"
		fi
	done

	echo Deleting all packages...
	pkg_delete -r -R \* > /dev/null 2>&1  # this 'fails' every time
	pkg_delete -r -R \* > /dev/null 2>&1  # sometimes, running it twice works.  yeah, it's a hack
	pkg_delete -f -f -r -R \* > /dev/null 2>&1  # and sometimes, you need the double-F...
	if [ `pkg_info | wc -l` -gt 0 ]; then
		echo ...failed!  Most packages have been deleted, but some remain:
		pkg_info
		echo
		echo Figure out how to delete those, then look in this script for the command line
		echo to use to install all your packages.  Once you\'ve done that, start all the 
		echo packages listed in ${TORESTART}. 
		exit 4
	fi

	echo Installing new packages...
	SUCCESS=`cat ${INSTALLLIST} | xargs -n 1 -t pkg_add`
	if [ ! ${SUCCESS} ]; then
		echo ...failed!  Not all packages were installed correctly.  You\'ll need to figure out
		echo what went wrong and then get the rest installed, or you could delete all the
		echo installed packages and re-install them all from ${INSTALLLIST}. 
		echo Once you\'ve done that, start all the packages listed in ${TORESTART}.
		exit ${SUCCESS}
	fi

	if which xtail > /dev/null 2>&1 ; then
		STARTUPLOG=`tempname`
		xtail /var/log > ${STARTUPLOG} &
		LOGPID=$!
	fi

	echo Re-starting all stopped packages...
	for pkgname in `cat ${TORESTART}`; do
		if [ -f ${pkgname} ]; then
			echo starting ${pkgname}
			if ./${pkgname} start > /dev/null 2>&1; then
			else
				echo 1>&2
				echo WARNING: unable to re-start ${pkgname} 1>&2
				echo 1>&2
			fi
		else
			echo WARNING: run-script for ${pkgname} disappeared 1>&2
		fi
	done

	rm ${TORESTART}

	if [ $LOGPID ]; then
		kill ${LOGPID}
		echo Log messages generated during package re-start:
		cat ${STARTUPLOG}
		echo
		rm ${STARTUPLOG}
	fi

	list_matched_packages()
	{
		for i in `pkg_info | awk '{ print $1}'`; do
			grep \/$i ${INSTALLLIST}
		done
	}
	echo Checking if all desired packages are installed...
	MATCHED=`list_matched_packages` # ignore return code because some won't match
	MATCHCOUNT=`echo "${MATCHED}" | wc -l` || die $?
	DESIREDCOUNT=`cat ${INSTALLLIST} | wc -l` || die $?

	if [ ${MATCHCOUNT} -eq ${DESIREDCOUNT} ]; then
		echo ...success!
	else
		echo "...failure!  Differing packages (desired/installed):"
		LEFT=`tempname`
		RIGHT=`tempname`
		cat ${INSTALLLIST} | sort > ${LEFT} || die $?
		list_matched_packages | sort > ${RIGHT} || die $?
		diff ${LEFT} ${RIGHT} || die $?
		rm ${LEFT} ${RIGHT}
		die 7
	fi

	echo Done!

	exit 0
) 2>&1 | tee -a ${BULKLOG}

exit $?

