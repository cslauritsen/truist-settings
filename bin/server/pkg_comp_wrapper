#!/bin/sh

set -eu

PKG_COMP=/usr/pkg/sbin/pkg_comp
PKGIN=/usr/pkg/bin/pkgin

FAST=
if [ $# -gt 0 ] && [ '-f' = "$1" ]; then
	FAST="$1"
	shift
fi

PKGLIST="$@"

# do this early in case there's any problem loading it
. ~/bin/util/pkg_comp_util.sh  # this will also grab util.sh

# do this early in case there are any invalid package names in the list
echo "Initializing package name cache and checking for errors..."
if [ -n "$PKGLIST" ]; then
	# trick pkg_comp_util into using our shortened list
	TEMPFILE="`tempname`"
	echo "$PKGLIST" | tr ' ' "\n" > "$TEMPFILE"
	PKG_LIST="$TEMPFILE"
fi
_uncached_desired_package_name >/dev/null || die $?

echo "Destroying old sandbox (and ignoring errors)..."
$PKG_COMP sandbox-destroy || true

echo "Creating new sandbox..."
$PKG_COMP sandbox-create || die $? "Error creating sandbox"

echo "Building..."
$PKG_COMP auto $FAST $PKGLIST || die $? "Error during 'auto' build"

echo "Checking that all desired packages exist..."
_do_diff 'desired_package_names' 'current_package_files' || die $? "Some desired packages are missing"

echo "Destroying new sandbox..."
$PKG_COMP sandbox-destroy || die $? "Error destroying sandbox"

echo "Running 'pkgin update'..."
$PKGIN update || die $? "Error running 'pkgin update'"

echo "Done!"
exit 0
